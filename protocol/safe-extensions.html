<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Safe Extensions - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/protocol/safe-extensions.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="safe-contract-extensions"><a class="header" href="#safe-contract-extensions">Safe Contract Extensions</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#security-council-liveness-checking-extensions">Security Council Liveness Checking Extensions</a>
<ul>
<li><a href="#the-liveness-guard">The Liveness Guard</a></li>
<li><a href="#the-liveness-module">The Liveness Module</a></li>
<li><a href="#owner-removal-call-flow">Owner Removal Call Flow</a></li>
<li><a href="#shutdown">Shutdown</a></li>
<li><a href="#liveness-security-properties">Liveness Security Properties</a>
<ul>
<li><a href="#liveness-guard-security-properties">Liveness Guard Security Properties</a></li>
<li><a href="#liveness-module-security-properties">Liveness Module Security Properties</a></li>
</ul>
</li>
<li><a href="#interdependency-between-the-liveness-guard-and-liveness-module">Interdependency between the Liveness Guard and Liveness Module</a></li>
</ul>
</li>
<li><a href="#operational-considerations">Operational Considerations</a>
<ul>
<li><a href="#manual-validation-of-new-owner-liveness">Manual validation of new owner liveness</a></li>
<li><a href="#deploying-the-liveness-checking-system">Deploying the Liveness Checking System</a></li>
<li><a href="#modifying-the-liveness-checking-system">Modifying the Liveness Checking System</a>
<ul>
<li><a href="#replacing-the-liveness-module">Replacing the Liveness Module</a></li>
<li><a href="#replacing-the-liveness-guard">Replacing the Liveness Guard</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>This document describes extensions to the Security Council and Guardian Safe contracts, which
provide additional functionality and security guarantees on top of those provided by the Safe
contract.</p>
<p>These extensions are developed using two types of contracts
(<a href="https://docs.safe.global/advanced/smart-account-modules">modules</a> and
<a href="https://docs.safe.global/advanced/smart-account-guards">guards</a>) which the Safe contract has
built-in support for:</p>
<ol>
<li><strong>Guard contracts:</strong> can execute pre- and post- transaction checks.</li>
<li><strong>Module contracts:</strong> a contract which is
authorized to execute transactions via the Safe. This means the module must properly implement
auth conditions internally.</li>
</ol>
<p>For more information about the Security Council and Guardian roles, refer to the
<a href="./stage-1.html">Stage One Roles and Requirements</a> document.</p>
<h2 id="security-council-liveness-checking-extensions"><a class="header" href="#security-council-liveness-checking-extensions">Security Council Liveness Checking Extensions</a></h2>
<p>The Security Council Safe is extended by the Liveness Checking Module and Guard. These extensions
are intended to ensure that any loss of access to a signer's keys is identified and addressed
within a predictable period of time.</p>
<p>This mechanism is intended only to be used to remove signers who have lost access to their keys, or
are otherwise inactive. It is not intended to be used to remove signers who are acting in bad faith,
or any other subjective criteria, such cases should be addressed by governance, and the removal
handled via the standard Safe ownership management functionality.</p>
<h3 id="the-liveness-guard"><a class="header" href="#the-liveness-guard">The Liveness Guard</a></h3>
<p>For implementing liveness checks a <code>LivenessGuard</code> is created which receives the signatures from
each executed transaction, and tracks the latest time at which a transaction was signed by each
signer. This time is made publicly available by calling a <code>lastLive(address)(Timestamp)</code> method.</p>
<p>Owners are recorded in this mapping in one of 4 ways:</p>
<ol>
<li>Upon deployment, the guard reads the current set of owners from the Safe contract.</li>
<li>When a new owner is added to the safe. Similarly, when an owner is removed from the Safe, its
entry is deleted from the mapping.</li>
<li>When a transaction is executed, the signatures on that transaction are passed to the guard and
used to identify the signers. If more than the required number of signatures is provided, they
are ignored.</li>
<li>An owner may call the contract's <code>showLiveness()()</code> method directly in order to prove liveness.</li>
</ol>
<p>Note that the first two methods do not require the owner to actually sign anything. However these
mechanisms are necessary to prevent new owners from being removed before they have had a chance to
show liveness.</p>
<h3 id="the-liveness-module"><a class="header" href="#the-liveness-module">The Liveness Module</a></h3>
<p>A <code>LivenessModule</code> is also created which does the following:</p>
<ol>
<li>Has a function <code>removeOwners()</code> that anyone may call to specify one or more owners to be removed
from the Safe.</li>
<li>The Module would then check the <code>LivenessGuard.lastLive()</code> to determine if the signer is eligible
for removal.</li>
<li>If so, it will call the Safe's <code>removeSigner()</code> to remove the non-live signer, and if necessary
reduce the threshold.</li>
<li>When a member is removed, the signing parameters are modified such that <code>M/N</code> is the lowest ratio
which remains greater than or equal to 75%. Using integer math, this can be expressed as
<code>M = (N * 75 + 99) / 100</code>.</li>
</ol>
<h3 id="owner-removal-call-flow"><a class="header" href="#owner-removal-call-flow">Owner Removal Call Flow</a></h3>
<p>The following diagram illustrates the flow for removing a single owner. The <code>verifyFinalState</code> box
indicates calls to the Safe which ensure the final state is valid.</p>
<pre class="mermaid">sequenceDiagram
    participant User
    participant LivenessModule
    participant LivenessGuard
    participant Safe
    User-&gt;&gt;LivenessModule: removeOwners([previousOwner], [owner])
    LivenessModule-&gt;&gt;LivenessGuard: lastLive(owner)
    LivenessModule-&gt;&gt;Safe: getOwners()
    LivenessModule-&gt;&gt;Safe: removeOwner(previousOwner, owner)

    alt verifyFinalState
    LivenessModule-&gt;&gt;Safe: getOwners()
    LivenessModule-&gt;&gt;Safe: getThreshold()
    LivenessModule-&gt;&gt;Safe: getGuard()
    end
</pre>
<h3 id="shutdown"><a class="header" href="#shutdown">Shutdown</a></h3>
<p>In the unlikely event that the signer set (<code>N</code>) is reduced below the allowed minimum number of
owners, then (and only then) is a shutdown mechanism activated which removes the existing signers,
and hands control of the multisig over to a predetermined entity.</p>
<h3 id="liveness-security-properties"><a class="header" href="#liveness-security-properties">Liveness Security Properties</a></h3>
<p>The following security properties must be upheld:</p>
<h4 id="liveness-guard-security-properties"><a class="header" href="#liveness-guard-security-properties">Liveness Guard Security Properties</a></h4>
<ol>
<li>Signatures are assigned to the correct signer.</li>
<li>Non-signers are unable to create a record of having signed.</li>
<li>An owner cannot be censored or griefed such that their signing is not recorded.</li>
<li>Owners may demonstrate liveness either by signing a transaction or by calling directly to the
guard.</li>
<li>It must be impossible for the guard's <code>checkTransaction</code> or <code>checkAfterExecution</code> method to
permanently revert given any calldata and the current state.</li>
<li>The guard correctly handles updates to the owners list, such that new owners are recorded, and
removed owners are deleted.
<ol>
<li>An <code>ownersBefore</code> enumerable set variable is used to accomplish this, it must be emptied at
the end of the <code>checkAfterExecution</code> call.</li>
</ol>
</li>
</ol>
<h4 id="liveness-module-security-properties"><a class="header" href="#liveness-module-security-properties">Liveness Module Security Properties</a></h4>
<ol>
<li>During a shutdown the module correctly removes all signers, and converts the safe to a 1 of 1.</li>
<li>The module only removes an owner if they have not demonstrated liveness during the interval, or
if enough other owners have been removed to activate the shutdown mechanism.</li>
<li>The module correctly sets the Safe's threshold upon removing a signer.</li>
</ol>
<p>Note: neither the module nor guard attempt to prevent a quorum of owners from removing either the
liveness module or guard. There are legitimate reasons they might wish to do so. Moreover, if such a
quorum of owners exists, there is no benefit to removing them, as they are defacto 'sufficiently
live'.</p>
<h3 id="interdependency-between-the-liveness-guard-and-liveness-module"><a class="header" href="#interdependency-between-the-liveness-guard-and-liveness-module">Interdependency between the Liveness Guard and Liveness Module</a></h3>
<p>The guard has no dependency on the module, and can be used independently to track liveness of Safe
owners.</p>
<p>This means that the module can be removed or replaced without any affect on the guard.</p>
<p>The module however does have a dependency on the guard; if the guard is removed from the Safe, then
the module will no longer be functional and calls to its <code>removeOwners</code> function will revert.</p>
<h2 id="operational-considerations"><a class="header" href="#operational-considerations">Operational Considerations</a></h2>
<h3 id="manual-validation-of-new-owner-liveness"><a class="header" href="#manual-validation-of-new-owner-liveness">Manual validation of new owner liveness</a></h3>
<p>As <a href="#the-liveness-guard">noted above</a> newly added owners are recorded in the guard without
necessarily having signed a transaction. Off-chain validation of the liveness of an address must
therefore be done prior to adding a new owner.</p>
<h3 id="deploying-the-liveness-checking-system"><a class="header" href="#deploying-the-liveness-checking-system">Deploying the Liveness Checking System</a></h3>
<p>The module and guard are intended to be deployed and installed on the safe in the following
sequence:</p>
<ol>
<li>Deploy the guard contract. The guard's constructor will read the Safe's owners and set a
timestamp.</li>
<li>Deploy the module.</li>
<li>Set the guard on the safe.</li>
<li>Enable the module on the safe.</li>
</ol>
<p>This order of operations is necessary to satisfy the constructor checks in the module, and is
intended to prevent owners from being immediately removable.</p>
<p>Note that changes to the owners set should not be made between the time the module is deployed, and
when it is enabled on the Safe, otherwise the checks made in the module's constructor may be
invalidated. If such changes are made, a new module should be deployed.</p>
<h3 id="modifying-the-liveness-checking-system"><a class="header" href="#modifying-the-liveness-checking-system">Modifying the Liveness Checking System</a></h3>
<p>Changes to the liveness checking system should be done in the following manner:</p>
<h4 id="replacing-the-liveness-module"><a class="header" href="#replacing-the-liveness-module">Replacing the Liveness Module</a></h4>
<p>The module can safely be removed without affecting the operation of the guard. A new module can then
be added.</p>
<p>Note: none of the module's parameters are modifiable. In order to update the security properties
enforced by the module, it must be replaced.</p>
<h4 id="replacing-the-liveness-guard"><a class="header" href="#replacing-the-liveness-guard">Replacing the Liveness Guard</a></h4>
<p>The safe can only have one guard contract at a time, and if the guard is removed the module will
cease to function. This does not affect the ability of the Safe to operate normally, however the
module should be removed as a best practice.</p>
<p>If a new guard is added, eg. as a means of upgrading it, then a new module will also need to be
deployed and enabled. Once both the guard and module have been removed, they can be replaced
according to the steps in the <a href="#deploying-the-liveness-checking-system">Deployment</a> section above.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../protocol/configurability.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../protocol/stage-1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../protocol/configurability.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../protocol/stage-1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../specs/static/solidity.min.js"></script>
        <script src="../specs/static/mermaid.min.js"></script>
        <script src="../specs/static/mermaid-init.js"></script>


    </div>
    </body>
</html>
