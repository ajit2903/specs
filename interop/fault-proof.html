<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Fault Proof - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/interop/fault-proof.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="fault-proof"><a class="header" href="#fault-proof">Fault Proof</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#super-root-state-transition">Super Root State Transition</a>
<ul>
<li><a href="#transition-state">Transition State</a></li>
<li><a href="#invalid-state">Invalid State</a></li>
<li><a href="#local-safe-block-derivation">Local Safe Block Derivation</a></li>
<li><a href="#consolidation">Consolidation</a></li>
</ul>
</li>
<li><a href="#fault-proof-program-state-transition">Fault Proof Program State Transition</a></li>
<li><a href="#security-considerations">Security Considerations</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Interop introduces the Super Fault Dispute Game as a
new <a href="../fault-proof/stage-one/dispute-game-interface.html">dispute game</a> type. It is based on the
pre-interop <a href="../fault-proof/stage-one/fault-dispute-game.html">fault dispute game</a> with some modifications:</p>
<ul>
<li>Claims at and above the split depth are commitments to the state within the super root state transition described
below instead of output roots.</li>
<li>The L2 block number is replaced by the timestamp of the proposed super root.
<ul>
<li>The <code>l2BlockNumber()</code> method has been renamed <code>l2SequenceNumber()</code> in <code>IDisputeGame</code> interface to reflect that this
is an arbitrary identifier within the fully ordered sequence of chain states.</li>
</ul>
</li>
<li>The <a href="../fault-proof/stage-one/fault-dispute-game.html#l2-block-number-challenge">L2 block number challenge</a> is removed.
The super root state transition is now able to invalidate all proposals with an incorrect proposal timestamp as part
of the state transition.</li>
<li>While claims in the bottom half of the game still commit to the state of the FPVM, the fault proof program being
executed changes to verify the disputed step of the super root state transition instead of the application of a
disputed L2 block.</li>
<li>The L2 block number preimage oracle local key now always provides the timestamp of the proposal.</li>
<li>The L2 chain ID preimage oracle local key is no longer used and is never populated by the dispute game.</li>
</ul>
<h2 id="super-root-state-transition"><a class="header" href="#super-root-state-transition">Super Root State Transition</a></h2>
<p>The super fault dispute game defines a state transition from the current anchor state super root to the canonical super
root at the game's proposal timestamp, if one can be derived from the available L1 data or the invalid state if not.</p>
<p>As the valid state transition always extends to the game proposal's timestamp, proposing a super root with a timestamp
less than or greater than game's proposal timestamp will be found to be invalid. Similarly any root claim that is the
hash of a <code>TransitionState</code> will be found to be invalid.</p>
<p>To reduce the amount of processing required in a single invocation of the FPVM, the state transition breaks the
transition from the super root at one timestamp to the super root at the next timestamp into 128 steps. The claims for
these intermediate steps are <code>keccak256</code> hash of a <a href="#transition-state">transition state</a>. These 128 steps repeat to
transition between the super root at each timestamp from the anchor state until the proposal time is reached.</p>
<h3 id="transition-state"><a class="header" href="#transition-state">Transition State</a></h3>
<p>A transition state is RLP encoded data consisting of:</p>
<ul>
<li><code>SuperOutput []byte</code> - the encoded super output at the immediately prior timestamp. This is the super root that is
being transformed <em>from</em>.</li>
<li><code>PendingProgress []LocalSafeBlock</code> - the next block derived for each chain from L1 batch data, prior to validating
executing messages.
<ul>
<li><code>LocalSafeBlock</code> is two <code>bytes32</code> RLP encoded, the first being the block hash and the second the output root for
the block.</li>
</ul>
</li>
<li><code>Step</code> a <code>uint64</code> recording the number of steps applied to this <code>TransitionState</code> since the <code>SuperOutput</code>.</li>
</ul>
<h3 id="invalid-state"><a class="header" href="#invalid-state">Invalid State</a></h3>
<p>The invalid state is defined as <code>keccak256(utf8("invalid"))</code>. This state is used to indicate a state transition where
there is no possible valid proposal. The dispute game contract MUST prevent a game from being created where the root
claim is the invalid state.</p>
<p>When the prestate is the invalid state, the post state is also the invalid state.</p>
<h3 id="local-safe-block-derivation"><a class="header" href="#local-safe-block-derivation">Local Safe Block Derivation</a></h3>
<p>The first 127 steps derive the next local safe block for one chain in the super root using
the <a href="../protocol/derivation.html">derivation process</a>. Chains are processed in the order they appear in the super root
(ascending order of chain ID). The <code>Step</code> is incremented after each step.</p>
<p>For each step, the valid post state <code>TransitionState</code> is calculated by the algorithm:</p>
<ul>
<li>If the prestate is a SuperRoot, convert it to a <code>TransitionState</code> with <code>Step = 0</code> and <code>PendingProgress</code> an empty
array.</li>
<li>If <code>Step</code> is less than the number of chains included in <code>SuperOutput</code>, derive the next local safe block for the chain
at
index <code>Step</code> in the <code>SuperRoot</code> using the <a href="../protocol/derivation.html">derivation process</a>. Executing messages are not
checked at this stage.
<ul>
<li>No block is derived if <code>Step</code> is greater than the number of chains in the super root.</li>
<li>If the derivation process is unable to derive the next L1 block because the L1 head is reached, the post state is
the <a href="#invalid-state">invalid state</a></li>
</ul>
</li>
<li>Increment <code>Step</code></li>
</ul>
<p>Since one step is required per chain in the dependency set, the current dispute game can support a maximum of 127 chains
in the dependency set. If a greater number of chains are required in the future the number of steps can be increased.</p>
<h3 id="consolidation"><a class="header" href="#consolidation">Consolidation</a></h3>
<p>When the prestate is a <code>TransitionState</code> with <code>Step = 127</code>, the validity of executing messages is checked and any
local safe blocks found to contain invalid executing messages are replaced with deposit only blocks. This includes
recursively replacing any blocks with executing messages that became invalid because of another block being replaced.</p>
<p>The post state is defined as a super output where <code>timestamp</code> is the <code>SuperOutput</code> timestamp + 1, and the output roots
are set to the output roots of the validated blocks (including any required replacements).</p>
<h2 id="fault-proof-program-state-transition"><a class="header" href="#fault-proof-program-state-transition">Fault Proof Program State Transition</a></h2>
<p>Below the split depth, claims correspond to execution trace commitments of the FPVM, as with the pre-interop
<a href="../fault-proof/stage-one/fault-dispute-game.html">fault dispute game</a>. A single <strong>ABSOLUTE_PRESTATE</strong> continues to be used, with the fault proof
program identifying the type of step to perform based on the agreed prestate.</p>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<p>TODO</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../interop/supervisor.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../interop/upgrade.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../interop/supervisor.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../interop/upgrade.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../specs/static/solidity.min.js"></script>
        <script src="../specs/static/mermaid.min.js"></script>
        <script src="../specs/static/mermaid-init.js"></script>


    </div>
    </body>
</html>
