<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Managed Mode - OP Stack Specification</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-YNLKSPKGWN"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());
            gtag('config', 'G-YNLKSPKGWN');
        </script>
        <meta name="google-site-verification" content="1XjEcxxHshd6NM_mxbl_uv-SyamI6_99aOpILYI3_mk" />

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/interop/managed-mode.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="control-flow-between-supervisor-and-managed-node"><a class="header" href="#control-flow-between-supervisor-and-managed-node">Control flow between Supervisor and Managed node</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#node---supervisor">Node <code>-&gt;</code> Supervisor</a>
<ul>
<li><a href="#reset">Reset</a></li>
<li><a href="#unsafeblock">UnsafeBlock</a></li>
<li><a href="#derivationupdate">DerivationUpdate</a></li>
<li><a href="#derivationoriginupdate">DerivationOriginUpdate</a></li>
<li><a href="#exhaustl1">ExhaustL1</a></li>
<li><a href="#replaceblock">ReplaceBlock</a></li>
</ul>
</li>
<li><a href="#supervisor---node">Supervisor <code>-&gt;</code> Node</a>
<ul>
<li><a href="#control-signals">Control Signals</a>
<ul>
<li><a href="#interop_pullevent">interop_pullEvent</a></li>
<li><a href="#interop_anchorpoint-soon-to-be-deprecated">interop_anchorPoint (Soon to be deprecated)</a></li>
<li><a href="#interop_invalidateblock">interop_invalidateBlock</a></li>
<li><a href="#interop_providel1">interop_provideL1</a></li>
<li><a href="#interop_reset">interop_reset</a></li>
</ul>
</li>
<li><a href="#db">DB</a>
<ul>
<li><a href="#interop_updatecrosssafe">interop_updateCrossSafe</a></li>
<li><a href="#interop_updatecrossunsafe">interop_updateCrossUnsafe</a></li>
<li><a href="#interop_updatefinalized">interop_updateFinalized</a></li>
</ul>
</li>
<li><a href="#sync-methods">Sync Methods</a>
<ul>
<li><a href="#interop_fetchreceipts">interop_fetchReceipts</a></li>
<li><a href="#interop_l2blockrefbytimestamp">interop_l2BlockRefByTimestamp</a></li>
<li><a href="#interop_blockrefbynumber">interop_blockRefByNumber</a></li>
<li><a href="#interop_chainid">interop_chainID</a></li>
<li><a href="#interop_outputv0attimestamp">interop_outputV0AtTimestamp</a></li>
<li><a href="#interop_pendingoutputv0attimestamp">interop_pendingOutputV0AtTimestamp</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#types">Types</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<p>This section is based on the control flow between <code>managed</code> node and <code>supervisor</code>, described
<a href="https://github.com/ethereum-optimism/optimism/blob/develop/op-supervisor/README.md">here</a>.</p>
<p>Whether the node and supervisor use a <code>pubsub</code> pattern or pulling events over HTTP is up to the implementation detail.
Both cases should be handled because <code>op-node</code> and <code>op-supervisor</code> can be using different client implementations.
In both the case, we use <code>event</code> based signaling of new information. Ideally, this should be done using bi-directional
RPC using web sockets.</p>
<h2 id="authentication"><a class="header" href="#authentication">Authentication</a></h2>
<p>Supervisor <a href="https://github.com/ethereum-optimism/optimism/issues/13182">initiates the connection</a> to the node in order
to manage it. As supervisor does the dial in, for our context, it is the client and the node is the server. For the web
socket authentication, only the initial request is authenticated and a live socket is opened.
No re-authentication is needed during the lifetime of this socket.</p>
<p>The authentication is performed using <code>JWT</code>. The construction of jwt is the same to the one
<a href="https://github.com/ethereum/execution-apis/blob/main/src/engine/authentication.md">used in Engine API</a>. The path of
the file containing the jwt secret should be provided to the supervisor instance.</p>
<h2 id="node---supervisor"><a class="header" href="#node---supervisor">Node <code>-&gt;</code> Supervisor</a></h2>
<p>Events that a supervisor should subscribe to, originating from the node, handled by the supervisor. For the used types,
refer <a href="#Types">this</a> section.</p>
<p>Every event sent from the node is of type <code>ManagedEvent</code> whose fields are populated with the events that occurred. All
non-null events are sent at once. The other fields are omitted.</p>
<pre><code class="language-javascript">ManagedEvent {
    Reset,
    UnsafeBlock,
    DerivationUpdate,
    DerivationOriginUpdate,
    ExhaustL1,
    ReplaceBlock
}
</code></pre>
<p>Each field item is an event of the type as described below:</p>
<h3 id="reset"><a class="header" href="#reset">Reset</a></h3>
<pre><code class="language-javascript">Reset: string
</code></pre>
<p>This is emitted when the node has determined that it needs a reset. It tells the supervisor to send the
<a href="#interop_reset">interop_reset</a> event with the required parameters.</p>
<h3 id="unsafeblock"><a class="header" href="#unsafeblock">UnsafeBlock</a></h3>
<pre><code class="language-javascript">UnsafeBlock: BlockRef //L2's BlockRef
</code></pre>
<p>New L2 unsafe block was processed, updating local-unsafe head.</p>
<h3 id="derivationupdate"><a class="header" href="#derivationupdate">DerivationUpdate</a></h3>
<pre><code class="language-javascript">DerivationUpdate: DerivedBlockRefPair {
    source: BlockRef  //L1 
    derived: BlockRef //Last L2 BlockRef
}
</code></pre>
<p>Signals that an L2 block is considered local-safe.</p>
<h3 id="derivationoriginupdate"><a class="header" href="#derivationoriginupdate">DerivationOriginUpdate</a></h3>
<pre><code class="language-javascript">DerivationOriginUpdate: BlockRef
</code></pre>
<p>Signals that an L2 block is now local-safe because of the given L1 traversal. This would be accompanied with
<code>DerivationUpdate</code>.</p>
<h3 id="exhaustl1"><a class="header" href="#exhaustl1">ExhaustL1</a></h3>
<pre><code class="language-javascript">ExhaustL1: DerivedBlockRefPair {
    source: BlockRef  //Last L1
    derived: BlockRef //Last L2 BlockRef
}
</code></pre>
<p>Emitted when no more L1 Blocks are available. Ready to take new L1 blocks from supervisor.</p>
<h3 id="replaceblock"><a class="header" href="#replaceblock">ReplaceBlock</a></h3>
<pre><code class="language-javascript">ReplaceBlock: BlockReplacement
</code></pre>
<p>Emitted when a block gets replaced for any reason.</p>
<h2 id="supervisor---node"><a class="header" href="#supervisor---node">Supervisor <code>-&gt;</code> Node</a></h2>
<p>Messages that a node should watch for, originating from supervisor, handled by node. This also includes control signals
that the supervisor can ask the node to perform. For the used types, refer <a href="#types">this</a> section.</p>
<p><em>Note: Headings represent the actual name of the methods over RPC, payload is the serialized version of the given type.</em></p>
<p><code>-&gt; indicates return</code></p>
<h3 id="control-signals"><a class="header" href="#control-signals">Control Signals</a></h3>
<p>RPC calls that are relevant to managing the node via supervisor. These are directly called by the supervisor.</p>
<h4 id="interop_pullevent"><a class="header" href="#interop_pullevent">interop_pullEvent</a></h4>
<pre><code class="language-javascript">payload() -&gt; One of the event from node events (previous section).
</code></pre>
<p>When websocket is not available, supervisor can use this method to get the next event from node.</p>
<h4 id="interop_anchorpoint-soon-to-be-deprecated"><a class="header" href="#interop_anchorpoint-soon-to-be-deprecated">interop_anchorPoint (Soon to be deprecated)</a></h4>
<pre><code class="language-javascript">payload() -&gt; DerivedBlockRefPair {
    source: L1 BlockRef that rollup starts after (no derived transaction)
    derived: L2 BlockRef that rollup starts from (no txn, pre-configuration state)
}
</code></pre>
<p>Returns the genesis block ref for L1 and L2 that the current node used as anchor point.
This method will soon be removed in favor of fetching the information from a supervisor specific rollup config.
(Once a spec is created about <a href="https://github.com/ethereum-optimism/optimism/pull/16038">this</a> PR.)</p>
<h4 id="interop_invalidateblock"><a class="header" href="#interop_invalidateblock">interop_invalidateBlock</a></h4>
<pre><code class="language-javascript">payload (BlockSeal)  //L2's Block
</code></pre>
<p>Based on some dependency or L1 changes, supervisor can instruct the L2 to invalidate a specific block.</p>
<p><em>(Suggestion: BlockSeal can be replaced with Hash, as only that is being used in op-node.)</em></p>
<h4 id="interop_providel1"><a class="header" href="#interop_providel1">interop_provideL1</a></h4>
<pre><code class="language-javascript">payload (BlockRef) //L1 Block
</code></pre>
<p>Supervisor sends the next L1 block to the node. Ideally sent after the node emits <code>exhausted-l1</code>.</p>
<h4 id="interop_reset"><a class="header" href="#interop_reset">interop_reset</a></h4>
<pre><code class="language-javascript">payload (lUnsafe, xUnsafe, lSafe, xSafe, finalized: BlockID)
</code></pre>
<p>Forces a reset to a specific local-unsafe/local-safe/finalized starting point only if the blocks did exist. Resets may
override local-unsafe, to reset the very end of the chain. Resets may override local-safe, since post-interop we need
the local-safe block derivation to continue.</p>
<h3 id="db"><a class="header" href="#db">DB</a></h3>
<p>RPC calls that a node should watch for, originating from supervisor that is called on DB updates for relevant block
safety info for a given chain and block.</p>
<h4 id="interop_updatecrosssafe"><a class="header" href="#interop_updatecrosssafe">interop_updateCrossSafe</a></h4>
<pre><code class="language-javascript">payload (derived: BlockID, source: BlockID)
</code></pre>
<p>Signal that a block can be promoted to cross-safe.</p>
<h4 id="interop_updatecrossunsafe"><a class="header" href="#interop_updatecrossunsafe">interop_updateCrossUnsafe</a></h4>
<pre><code class="language-javascript">payload (BlockID)
</code></pre>
<p>Signal that a block can be promoted to cross-unsafe.</p>
<h4 id="interop_updatefinalized"><a class="header" href="#interop_updatefinalized">interop_updateFinalized</a></h4>
<pre><code class="language-javascript">payload (BlockID)
</code></pre>
<p>Signal that a block can be marked as finalized.</p>
<h3 id="sync-methods"><a class="header" href="#sync-methods">Sync Methods</a></h3>
<p>RPC methods that are relevant for syncing the supervisor. These are directly called by the supervisor for fetching L2
data.</p>
<h4 id="interop_fetchreceipts"><a class="header" href="#interop_fetchreceipts">interop_fetchReceipts</a></h4>
<pre><code class="language-javascript">payload (Hash) -&gt; Receipts //L2 block hash
</code></pre>
<p>Fetches all transaction receipts in a given L2 block.</p>
<h4 id="interop_l2blockrefbytimestamp"><a class="header" href="#interop_l2blockrefbytimestamp">interop_l2BlockRefByTimestamp</a></h4>
<pre><code class="language-javascript">payload (uint64) -&gt; BlockRef
</code></pre>
<p>Fetches L2 BlockRef of the block that occurred at given timestamp</p>
<h4 id="interop_blockrefbynumber"><a class="header" href="#interop_blockrefbynumber">interop_blockRefByNumber</a></h4>
<pre><code class="language-javascript">payload (uint64) -&gt; BlockRef
</code></pre>
<p>Fetches the BlockRef from a given L2 block number</p>
<h4 id="interop_chainid"><a class="header" href="#interop_chainid">interop_chainID</a></h4>
<pre><code class="language-javascript">payload () -&gt; string
</code></pre>
<p>Returns chainID of the L2</p>
<h4 id="interop_outputv0attimestamp"><a class="header" href="#interop_outputv0attimestamp">interop_outputV0AtTimestamp</a></h4>
<pre><code class="language-javascript">payload (uint64) -&gt; OutputV0
</code></pre>
<p>Returns the state root, storage root and block hash for a given timestamp</p>
<h4 id="interop_pendingoutputv0attimestamp"><a class="header" href="#interop_pendingoutputv0attimestamp">interop_pendingOutputV0AtTimestamp</a></h4>
<pre><code class="language-javascript">payload (uint64) -&gt; OutputV0
</code></pre>
<p>Returns the optimistic output of the invalidated block from replacement</p>
<p><strong>Note:</strong> All events should return relevant error(s) in case of unsuccessful calls.</p>
<h2 id="types"><a class="header" href="#types">Types</a></h2>
<pre><code class="language-javascript">Hash: 0x prefixed, hex encoded, fixed-length string representing 32 bytes

BlockID {
    hash: Hash
    number: uint64
}

BlockSeal {
    hash: Hash
    number: uint64
    timestamp: uint64
}

BlockRef {
    hash: Hash
    number: uint64
    parentHash: Hash
    timestamp: uint64
}

DerivedBlockRefPair {
    source: BlockRef
    derived: BlockRef
}

BlockReplacement {
    replacement: BlockRef
    invalidated: Hash
}

Receipts -&gt; []Receipt

Receipt -&gt; op-geth/core/types/receipt

OutputV0 {
    stateRoot: Hash
    messagePasserStorageRoot: Hash
    blockHash: Hash
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../interop/supervisor.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../interop/fault-proof.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../interop/supervisor.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../interop/fault-proof.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../specs/static/solidity.min.js"></script>
        <script src="../specs/static/mermaid.min.js"></script>
        <script src="../specs/static/mermaid-init.js"></script>


    </div>
    </body>
</html>
